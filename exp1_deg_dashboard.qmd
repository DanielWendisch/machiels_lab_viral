---
title: "Experiment 1 - differentially expressed genes dashboard"
format: dashboard
---

```{r include=FALSE}
#if (!require(devtools)) install.packages("devtools")
#devtools::install_github("gaospecial/ggVennDiagram")
library("patchwork")
easypackages::libraries("tidyverse", "tidyr", "tidygate", "ggVennDiagram", "VennDiagram", "purr", "ggpointdensity")
```

```{r, functions, include=FALSE}
fc_by_fc_ploter <- function(lst,
                            plot_i=1,
                    color_highlight="red",
                    fc_thresh_upper = 0.66,
                    log2_FC_tresh_x,
                    power_tresh) {
  
  plot_ <- lst[[plot_i]] |> full_join(lst[[2]], by="gene")|>  
    mutate(avg_log2FC.x=ifelse(avg_log2FC.x>4,4,avg_log2FC.x),
           avg_log2FC.x=ifelse(avg_log2FC.x<(-4),(-4),avg_log2FC.x),
           avg_log2FC.y=ifelse(avg_log2FC.y>4,4,avg_log2FC.y),
           avg_log2FC.y=ifelse(avg_log2FC.y<(-4),(-4),avg_log2FC.y)) |> 
    #replace_na(list(avg_log2FC.x=0,avg_log2FC.y=0)) |>
    #mutate(dist_from_0.5 =abs(myAUC.x-0.5)) |> 
    arrange(power.x) |> 
    mutate(fc_ratio=avg_log2FC.y/avg_log2FC.x) |> 
    mutate(highlight_genes=case_when(
      (#fc_ratio<fc_thresh_upper  &
         avg_log2FC.x>log2_FC_tresh_x&
        power.x>power_tresh)  ~"highlight",
      TRUE~"no"
      
    ))
  
  if (log2_FC_tresh_x<0) {plot_ <- plot_ |>mutate(highlight_genes=case_when(
      (#fc_ratio<fc_thresh_upper  &
         avg_log2FC.x<(log2_FC_tresh_x)&
        power.x>power_tresh)  ~"highlight",
      TRUE~"no"
      
    ))
    
  }
plot_ <- plot_|> 
    mutate(highlight_genes=factor(highlight_genes,levels=c("no", "highlight"))) |> 
    ggplot(aes(avg_log2FC.x,avg_log2FC.y, color=highlight_genes),alpha=0.5)+
        geom_abline(intercept = 0, slope = 1, color="black", 
                linetype="dashed", linewidth=1)+
    geom_jitter() +
    scale_color_manual(values=c("grey",color_highlight))+
    theme_bw()+
    #coord_fixed()+
    theme(legend.position = "none")+
    #xlim((-4.2),4.2)+
    #ylim((-4.2),4.2)+
    ggtitle(lst[[plot_i]][1,"comparison"])
  return(plot_)
  
}

vulcano_x <- function(lst,i, power_tresh=power_tresh_standard,log2_FC_tresh_x=log2_FC_tresh_x_standard) {
  tbl <- lst[[i]]
  
   tbl <- tbl |> 
                  mutate(avg_log2FC=ifelse(avg_log2FC>4,4,avg_log2FC),
                         avg_log2FC=ifelse(avg_log2FC<(-4),(-4),avg_log2FC),avg_log2FC#,
                         #power=if_else(power>0.55,(0.55+runif(1,0.1,0.2)),power)
                         )|>
                  arrange(power) |> 
          mutate(highlight_genes=case_when(
                  ( avg_log2FC>log2_FC_tresh_x & power>power_tresh)  ~"highlight",
                  TRUE~"no"
                  
          )) 
  
  
    if (log2_FC_tresh_x<0) {
      #print("negative")
      tbl <- tbl |> mutate(highlight_genes=case_when(
      (#fc_ratio<fc_thresh_upper  &
avg_log2FC<(log2_FC_tresh_x) & power>power_tresh)  ~"highlight",
                  TRUE~"no"
      
    ))
    
    }
  tbl <- tbl |> 
    mutate(highlight_genes=factor(highlight_genes,levels=c("no", "highlight")))
  
  plot_ <- tbl|> 
                  ggplot(aes(avg_log2FC,power, color=highlight_genes
                             ),alpha=0.5)+
                  geom_point()+
    #xlim(-6,6)+
    ylim(-0,0.8) +
    theme_bw()+
    theme(axis.title.x = element_blank(),
          #axis.ticks.x = element_blank(),
          #axis.text.x = element_blank(),
          legend.position = "none")+
  scale_color_manual(values=c("grey", "blue"))
  
  return(plot_)
  }

```
```{r, load_data, include=FALSE }
markers_roc <- read_csv( "C:\\Users\\danne\\R_projects\\machiels_lab_viral\\intermediate_data\\seurat_obj_experiment_1_bal_alv_mac_markers_roc.csv")

lst <- markers_roc |> group_by(comparison) |> group_split()
```

```{r, set_power_0.3, include=FALSE }
color_highlight="red"

log2_FC_tresh_x_standard <- 1

power_tresh_standard <- 0.3
fc_thresh_upper <- 0.66
```


# Power 0.3




## Row 
```{r, set_fc_fc_plots}
#| echo: false

fc_by_fc_1 <- fc_by_fc_ploter(lst = lst,plot_i = 1,
                              log2_FC_tresh_x =log2_FC_tresh_x_standard,
                              power_tresh = power_tresh_standard)
fc_by_fc_3 <- fc_by_fc_ploter(lst = lst,plot_i = 3,
                              log2_FC_tresh_x =log2_FC_tresh_x_standard,
                              power_tresh = power_tresh_standard)
fc_by_fc_4 <- fc_by_fc_ploter(lst = lst,plot_i = 4,
                              log2_FC_tresh_x =log2_FC_tresh_x_standard,
                              power_tresh = power_tresh_standard)
fc_by_fc_5 <- fc_by_fc_ploter(lst = lst,plot_i = 5,
                              log2_FC_tresh_x =log2_FC_tresh_x_standard,
                              power_tresh = power_tresh_standard)
```

#### Column {width=12%}
```{r, vulcano_y_here}
#| fig-width: 3
#| fig-height: 6
vulc <- vulcano_x(lst = lst,i = 2,power_tresh = power_tresh_standard,log2_FC_tresh_x = log2_FC_tresh_x_standard)
(plot_spacer())/(vulc+coord_flip()+scale_y_reverse()+ggtitle("Mock Ms4a3 pos vs. neg."))+ 
  plot_layout(heights =  c(1, 3))
```
#### Column {width=22%}
```{r}
#| title: A
#| fig-width: 5.5
#| fig-height: 6

vulc <- vulcano_x(lst = lst,i = 1,power_tresh = power_tresh_standard,log2_FC_tresh_x = log2_FC_tresh_x_standard)

vulc/ fc_by_fc_1+ 
  plot_layout(heights =  c(1, 3))
```

#### Column {width=22%}
```{r}
#| title: B
#| fig-width: 5.5
#| fig-height: 6
vulc <- vulcano_x(lst = lst,i = 3,power_tresh = power_tresh_standard,log2_FC_tresh_x = log2_FC_tresh_x_standard)
vulc/ fc_by_fc_3+ 
  plot_layout(heights =  c(1, 3))
```

#### Column {width=22%}
```{r}
#| title: C
#| fig-width: 5.5
#| fig-height: 6

vulc <- vulcano_x(lst = lst,i = 4,power_tresh = power_tresh_standard,log2_FC_tresh_x = log2_FC_tresh_x_standard)
vulc/ fc_by_fc_4+ 
  plot_layout(heights =  c(1, 3))
```

#### Column {width=22%}
```{r}
#| title: D
#| fig-width: 5.5
#| fig-height: 6
vulc <- vulcano_x(lst = lst,i = 5,power_tresh = power_tresh_standard,log2_FC_tresh_x = log2_FC_tresh_x_standard)
vulc/ fc_by_fc_5+ 
  plot_layout(heights =  c(1, 3))
```
## Row 
### Column
```{r}
#| title: shared DEG Ms4a3 pos. vs neg.
venn_dat <- list(
  A = (fc_by_fc_1[[1]] |> filter(highlight_genes=="highlight") |> pull(gene)), 
  B = (fc_by_fc_3[[1]] |> filter(highlight_genes=="highlight") |> pull(gene)), 
  C = (fc_by_fc_4[[1]] |> filter(highlight_genes=="highlight") |> pull(gene)),
  D = (fc_by_fc_5[[1]] |> filter(highlight_genes=="highlight") |> pull(gene)))
  
venn1 <- ggVennDiagram(venn_dat, label_alpha = 0)
venn1


```

### Column
```{r}
#| title: Fold changes intragroup - Ms4a3 pos. vs neg.
overlap <- calculate.overlap(venn_dat)

genes_highlighted_tbl <- fc_by_fc_1[[1]] |> filter(highlight_genes=="highlight") |> 
        bind_rows(fc_by_fc_3[[1]] |> filter(highlight_genes=="highlight")
                  ) |> 
        bind_rows(fc_by_fc_4[[1]] |> filter(highlight_genes=="highlight")
                  ) |> 
        bind_rows(fc_by_fc_5[[1]] |> filter(highlight_genes=="highlight")
                  ) 



genes_highlighted <- genes_highlighted_tbl|> pull(gene)

colnames(genes_highlighted_tbl) <- str_remove_all(colnames(genes_highlighted_tbl),".x")

dat <- markers_roc |> 
        full_join(genes_highlighted_tbl) |> 
        filter(gene %in% genes_highlighted) |> 
         arrange(factor(gene, levels = (list_c(overlap))))


dat|> ggplot(aes(gene,comparison, size=power, fill=avg_log2FC, color=highlight_genes))+
        geom_point(shape=21, stroke=2)+
        theme_minimal()+theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+scale_fill_viridis_b()

#+ scale_colour_manual(c("#E69F00", "#56B4E9"))
        

```



# Power 0.2

```{r read_chuncks}
knitr::read_chunk('test_code_cunck.R')
```

```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- 1
power_tresh_standard <- 0.2
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```

# Power 0.15
```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- 1
power_tresh_standard <- 0.15
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```

# Power 0.3, negative FC

```{r }
knitr::read_chunk('test_code_cunck.R')
```

```{r, , include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- -1
power_tresh_standard <- 0.3
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```
# Power 0.2, negative FC

```{r }
knitr::read_chunk('test_code_cunck.R')
```

```{r, set_power_0.2, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- -1
power_tresh_standard <- 0.2
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```
# Power 0.15, negative FC

```{r }
knitr::read_chunk('test_code_cunck.R')
```

```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- -1
power_tresh_standard <- 0.15
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```