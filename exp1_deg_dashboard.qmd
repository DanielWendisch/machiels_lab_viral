---
title: "Experiment 1 - AUROC differentially expressed genes dashboard"
format: dashboard
---

```{r include=FALSE}
#if (!require(devtools)) install.packages("devtools")
#devtools::install_github("gaospecial/ggVennDiagram")
library("patchwork")
easypackages::libraries("tidyverse", "tidyr", "tidygate", "ggVennDiagram", "VennDiagram", "ggpointdensity", "DT")
```

```{r, functions, include=FALSE}
fc_by_fc_ploter <- function(lst,
                            plot_i=1,
                    color_highlight="red",
                    fc_thresh_upper = 0.66,
                    log2_FC_tresh_x,
                    power_tresh) {
  
  plot_ <- lst[[plot_i]] |> full_join(lst[[2]], by="gene")|>  
    mutate(avg_log2FC.x=ifelse(avg_log2FC.x>4,4,avg_log2FC.x),
           avg_log2FC.x=ifelse(avg_log2FC.x<(-4),(-4),avg_log2FC.x),
           avg_log2FC.y=ifelse(avg_log2FC.y>4,4,avg_log2FC.y),
           avg_log2FC.y=ifelse(avg_log2FC.y<(-4),(-4),avg_log2FC.y)) |> 
    #replace_na(list(avg_log2FC.x=0,avg_log2FC.y=0)) |>
    #mutate(dist_from_0.5 =abs(myAUC.x-0.5)) |> 
    arrange(power.x) |> 
    mutate(fc_ratio=avg_log2FC.y/avg_log2FC.x) |> 
    mutate(highlight_genes=case_when(
      (#fc_ratio<fc_thresh_upper  &
         avg_log2FC.x>log2_FC_tresh_x&
        power.x>power_tresh)  ~"highlight",
      TRUE~"no"
      
    ))
  
  if (log2_FC_tresh_x<0) {plot_ <- plot_ |>mutate(highlight_genes=case_when(
      (#fc_ratio<fc_thresh_upper  &
         avg_log2FC.x<(log2_FC_tresh_x)&
        power.x>power_tresh)  ~"highlight",
      TRUE~"no"
      
    ))
    
  }
plot_ <- plot_|> 
    mutate(highlight_genes=factor(highlight_genes,levels=c("no", "highlight"))) |> 
    ggplot(aes(avg_log2FC.x,avg_log2FC.y, color=highlight_genes),alpha=0.5)+
        geom_abline(intercept = 0, slope = 1, color="black", 
                linetype="dashed", linewidth=1)+
    geom_jitter() +
    scale_color_manual(values=c("grey",color_highlight))+
    theme_bw()+
    #coord_fixed()+
    theme(legend.position = "none")+
    #xlim((-4.2),4.2)+
    #ylim((-4.2),4.2)+
    ggtitle(lst[[plot_i]][1,"comparison"])
  return(plot_)
  
}

vulcano_x <- function(lst,i, power_tresh=power_tresh_standard,log2_FC_tresh_x=log2_FC_tresh_x_standard) {
  tbl <- lst[[i]]
  
   tbl <- tbl |> 
                  mutate(avg_log2FC=ifelse(avg_log2FC>4,4,avg_log2FC),
                         avg_log2FC=ifelse(avg_log2FC<(-4),(-4),avg_log2FC),avg_log2FC#,
                         #power=if_else(power>0.55,(0.55+runif(1,0.1,0.2)),power)
                         )|>
                  arrange(power) |> 
          mutate(highlight_genes=case_when(
                  ( avg_log2FC>log2_FC_tresh_x & power>power_tresh)  ~"highlight",
                  TRUE~"no"
                  
          )) 
  
  
    if (log2_FC_tresh_x<0) {
      #print("negative")
      tbl <- tbl |> mutate(highlight_genes=case_when(
      (#fc_ratio<fc_thresh_upper  &
avg_log2FC<(log2_FC_tresh_x) & (power>power_tresh))  ~"highlight",
                  TRUE~"no"
      
    ))
    
    }
  tbl <- tbl |> 
    mutate(highlight_genes=factor(highlight_genes,levels=c("no", "highlight")))
  
  plot_ <- tbl|> 
                  ggplot(aes(avg_log2FC,power, color=highlight_genes
                             ),alpha=0.5)+
                  geom_point()+
    #xlim(-6,6)+
    ylim(-0,0.8) +
    theme_bw()+
    theme(axis.title.x = element_blank(),
          #axis.ticks.x = element_blank(),
          #axis.text.x = element_blank(),
          legend.position = "none")+
  scale_color_manual(values=c("grey", "blue"))
  
  return(plot_)
  }

```
```{r, load_data, include=FALSE }
markers_roc <- read_csv( "C:\\Users\\danne\\R_projects\\machiels_lab_viral\\intermediate_data\\seurat_obj_experiment_1_bal_alv_mac_markers_roc.csv")

lst <- markers_roc |> group_by(comparison) |> group_split()
```

```{r read_chuncks, include=FALSE}
knitr::read_chunk('test_code_cunck.R')
```
```{r, set_power_0.3, include=FALSE }
color_highlight="red"

log2_FC_tresh_x_standard <- 1

power_tresh_standard <- 0.3
fc_thresh_upper <- 0.66
```


# Power 0.3

```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- 1
power_tresh_standard <- 0.3
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```

# Power 0.2

```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- 1
power_tresh_standard <- 0.2
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```

# Power 0.15
```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- 1
power_tresh_standard <- 0.15
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```

# Power 0.3, negative FC

```{r }
knitr::read_chunk('test_code_cunck.R')
```

```{r, , include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- -1
power_tresh_standard <- 0.3
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```
# Power 0.2, negative FC

```{r }
knitr::read_chunk('test_code_cunck.R')
```

```{r, set_power_0.2, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- -1
power_tresh_standard <- 0.2
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```
# Power 0.1, negative FC

```{r }
knitr::read_chunk('test_code_cunck.R')
```

```{r, include=FALSE }
color_highlight="red"
log2_FC_tresh_x_standard <- -1
power_tresh_standard <- 0.1
fc_thresh_upper <- 0.66
```

```{r, child='child_deg_dashboard.qmd'}
```

# Table
```{r}
markers_roc |> mutate(power=round(power,3),
                      avg_log2FC=round(avg_log2FC,3),
                      avg_diff=round(avg_diff,3),
                      comparison=as_factor(comparison)
                      ) |> datatable(class = 'cell-border stripe',filter = 'top', options = list(
  pageLength = 10, autoWidth = TRUE
))
```

